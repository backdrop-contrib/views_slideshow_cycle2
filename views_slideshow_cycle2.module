<?php
/**
 * @file
 * Integrates the Cycle2 jQuery plugin with the Views Slideshow module.
 */

/**
 * Implements hook_config_info().
 */
function views_slideshow_cycle2_config_info() {
  return array(
    'views_slideshow_cycle2.settings' => array(
      'label' => t('Views Slideshow: Cycle2 settings'),
      'group' => t('Configuration'),
    ),
  );
}

/**
 * Implements hook_libraries_info().
 */
function views_slideshow_cycle2_libraries_info() {
  $libraries['jquery.cycle2'] = array(
    'name' => 'Cycle2',
    'vendor url' => 'http://jquery.malsup.com/cycle2/',
    'download url' => 'http://jquery.malsup.com/cycle2/download/',
    'version arguments' => array(
      'file' => 'jquery.cycle2.min.js',
      'pattern' => '/ver.*? ([a-z0-9\-\.]+)/i',
      'lines' => 5,
    ),
    'files' => array(
      'js' => array('jquery.cycle2.min.js'),
    ),
  );

  return $libraries;
}

/**
 * Implements hook_libraries_info_alter().
 *
 * Add plugins to the library, and get any effects provided by the plugins.
 */
function views_slideshow_cycle2_libraries_info_alter(&$libraries) {
  module_load_include('inc', 'views_slideshow_cycle2', 'views_slideshow_cycle2.plugins');

  // Ignore old effects (in case plugins have been removed).
  $effects = array();
  $transition_plugins = views_slideshow_cycle2_supported_plugins();

  // Get all plugins.
  $plugins = file_scan_directory(libraries_get_path('jquery.cycle2'), '/jquery\.cycle2\..*?\.min\.js/i');
  foreach ($plugins as $plugin) {
    // Add plugin to library.
    $libraries['jquery.cycle2']['files']['js'][$plugin->filename] = array('weight' => 1);

    // Get any effects.
    $filename_parts = explode('.', $plugin->filename);
    $plugin_name = $filename_parts[2];
    if (!empty($transition_plugins[$plugin_name])) {
      foreach ($transition_plugins[$plugin_name]['effects'] as $effect) {
        $effects[$effect] = $plugin->uri;
      }
    }
  }

  // Save new effects.
  config_set('views_slideshow_cycle2.settings', 'plugin_effects', $effects);
}

/**
 * Implements hook_theme().
 */
function views_slideshow_cycle2_theme($existing, $type, $theme, $path) {
  return array(
    'views_slideshow_cycle2_main_frame' => array(
      'variables' => array(
        'settings' => NULL,
        'vss_id' => NULL,
        'rows' => NULL,
        'view' => NULL,
      ),
      'file' => 'theme/views_slideshow_cycle2.theme.inc',
      'template' => 'theme/views-slideshow-cycle2-main-frame',
      'pattern' => 'views_slideshow_cycle2_main_frame__',
    ),
    'views_slideshow_cycle2_main_frame_slide' => array(
      'variables' => array(
        'fields' => NULL,
        'key' => NULL,
        'total' => NULL,
        'options' => NULL,
        'views_style_plugin' => NULL,
      ),
      'file' => 'theme/views_slideshow_cycle2.theme.inc',
      'template' => 'theme/views-slideshow-cycle2-main-frame-slide',
      'pattern' => 'views_slideshow_cycle2_main_frame_slide__',
    ),
  );
}

